---

- name: Accept loopback connections
  iptables:
    chain: INPUT
    in_interface: lo
    jump: ACCEPT

- name: Accept related and established connections
  iptables:
    chain: INPUT
    ctstate: ESTABLISHED,RELATED
    jump: ACCEPT

# todo: Only ips in whitelist can access ssh port
- name: Accept some tcp connections
  iptables:
    chain: INPUT
    ctstate: NEW
    match: tcp
    protocol: tcp
    in_interface: eth0
    destination_port: '{{ item }}'
    jump: ACCEPT
  with_items:
    - 22
    - 80
    - 443

- name: Set INPUT policy
  iptables:
    chain: INPUT
    policy: DROP

- name: Set FORWARD policy
  iptables:
    chain: FORWARD
    policy: DROP

- name: setup iptables network hooks
  copy:
    src: '{{ item.src }}'
    dest: '{{ item.dest }}'
    mode: 0755
  with_items:
    - { src: iptables.preup, dest: /etc/network/if-pre-up.d/iptables }
    - { src: iptables.postdown, dest: /etc/network/if-post-down.d/iptables }
...
